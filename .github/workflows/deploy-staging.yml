name: Deploy to Staging (Cloud Run)

on:
  push:
    branches:
      - staging

env:
  PROJECT_ID: brank-484008
  REGION: us-central1
  SERVICE_NAME: brank-backend-staging
  REPO_NAME: brank-backend-repo
  WORKLOAD_IDENTITY_PROVIDER: "projects/1089621666118/locations/global/workloadIdentityPools/gh-pool-v3/providers/gh-provider-cond"
  SERVICE_ACCOUNT: "github-actions-deployer@brank-484008.iam.gserviceaccount.com"

jobs:
  deploy:
    runs-on: ubuntu-latest

    permissions:
      contents: "read"
      id-token: "write"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Google Auth
        id: auth
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: "${{ env.WORKLOAD_IDENTITY_PROVIDER }}"
          service_account: "${{ env.SERVICE_ACCOUNT }}"

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Authorize Docker push
        run: gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev

      - name: Build and Push Container
        run: |
          docker build -t "${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/${{ env.SERVICE_NAME }}:${{ github.sha }}" .
          docker push "${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/${{ env.SERVICE_NAME }}:${{ github.sha }}"

      - name: Deploy and Run Migrations
        run: |
          # Get Cloud SQL instance connection name
          INSTANCE_CONNECTION_NAME=$(gcloud sql instances describe brank-db-instance-staging --project=${{ env.PROJECT_ID }} --format="value(connectionName)")

          # Construct DATABASE_URL for Cloud Run (Unix Socket)
          DATABASE_URL="postgresql+psycopg2://postgres:postgres@/brank_db_staging?host=/cloudsql/${INSTANCE_CONNECTION_NAME}"

          # 1. Deploy the Cloud Run Job
          gcloud run jobs deploy migrate-job-staging \
            --image "${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/${{ env.SERVICE_NAME }}:${{ github.sha }}" \
            --region ${{ env.REGION }} \
            --command "alembic" \
            --args "upgrade,head" \
            --service-account ${{ env.SERVICE_ACCOUNT }} \
            --set-env-vars="DATABASE_URL=${DATABASE_URL}" \
            --set-cloudsql-instances="${INSTANCE_CONNECTION_NAME}"

          # 2. Execute the Job and wait for completion
          gcloud run jobs execute migrate-job-staging --region ${{ env.REGION }} --wait

      - name: Deploy to Cloud Run
        uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: ${{ env.SERVICE_NAME }}
          region: ${{ env.REGION }}
          image: ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/${{ env.SERVICE_NAME }}:${{ github.sha }}
          flags: "--allow-unauthenticated --memory 4Gi --min-instances 1"
