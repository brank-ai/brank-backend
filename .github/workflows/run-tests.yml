name: Run Tests

on:
  pull_request:
    branches:
      - main
      - feature/**
      - develop
  push:
    branches:
      - main
      - develop

jobs:
  test:
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: brank_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: Create virtual environment
        run: uv venv

      - name: Install dependencies
        run: |
          uv pip install flask sqlalchemy alembic pydantic pydantic-settings python-dotenv requests openai google-generativeai tenacity psycopg2-binary pytest pytest-cov pytest-mock black isort mypy ruff

      - name: Create test .env file
        run: |
          cat > .env << 'EOF'
          # Test API Keys (using fake but valid-looking values for testing)
          CHATGPT_API_KEY=sk-proj-abcdef1234567890abcdef1234567890
          GEMINI_API_KEY=AIzaSyAbCdEf1234567890AbCdEf1234567890
          GROK_API_KEY=xai-1234567890abcdefghijklmnopqrstuvwxyz
          PERPLEXITY_API_KEY=pplx-1234567890abcdefghijklmnopqrstuvwxyz

          # Pipeline Configuration
          PROMPTS_N=5
          MIN_LLM_COUNT=2

          # Database (test database)
          DATABASE_URL=postgresql://postgres:postgres@localhost:5432/brank_test

          # Timeouts and Retries
          LLM_TIMEOUT_SECONDS=30
          MAX_RETRIES=3
          RETRY_MIN_WAIT=2
          RETRY_MAX_WAIT=10

          # Flask
          FLASK_ENV=testing
          SECRET_KEY=test-secret-key
          DEBUG=False

          # Logging
          LOG_LEVEL=INFO
          EOF

      - name: Run database migrations
        run: |
          source .venv/bin/activate
          alembic upgrade head

      - name: Run linting (Black)
        run: |
          source .venv/bin/activate
          black --check . || echo "::warning::Code formatting issues found. Run 'black .' locally to fix."

      - name: Run linting (isort)
        run: |
          source .venv/bin/activate
          isort --check-only . || echo "::warning::Import sorting issues found. Run 'isort .' locally to fix."

      - name: Run type checking (mypy)
        continue-on-error: true
        run: |
          source .venv/bin/activate
          mypy . || echo "::warning::Type checking issues found. Fix type hints locally."

      - name: Run tests with coverage
        run: |
          source .venv/bin/activate
          pytest -v --cov=. --cov-report=xml --cov-report=term-missing
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/brank_test

      - name: Upload coverage reports
        uses: codecov/codecov-action@v4
        if: always()
        continue-on-error: true
        with:
          file: ./coverage.xml
          flags: unittests
          name: codecov-umbrella

      - name: Test Summary
        if: always()
        run: |
          echo "===================================="
          echo "Test Run Summary"
          echo "===================================="
          echo ""
          if [ $? -eq 0 ]; then
            echo "✅ All tests passed!"
          else
            echo "❌ Some tests failed. Please review the logs above."
          fi
          echo ""
          echo "===================================="
